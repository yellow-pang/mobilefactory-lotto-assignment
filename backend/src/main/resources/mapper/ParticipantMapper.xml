<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.otr.lotto.mapper.ParticipantMapper">

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO participant (event_id, phone_hash)
    VALUES (#{eventId}, #{phoneHash})
  </insert>

  <select id="findByEventAndPhoneHash" resultType="com.otr.lotto.domain.Participant">
    SELECT
      id,
      event_id,
      phone_hash,
      check_count,
      first_checked_at,
      last_checked_at,
      created_at,
      updated_at
    FROM participant
    WHERE event_id = #{eventId}
      AND phone_hash = #{phoneHash}
  </select>

  <select id="countByEvent" resultType="long">
    SELECT COUNT(*)
    FROM participant
    WHERE event_id = #{eventId}
  </select>

  <update id="updateCheckCountAndTimestamps">
    UPDATE participant
    SET
      check_count = check_count + 1,
      first_checked_at = CASE
        WHEN check_count = 0 THEN #{checkedAt}
        ELSE first_checked_at
      END,
      last_checked_at = #{checkedAt}
    WHERE event_id = #{eventId}
      AND id = #{participantId}
  </update>

  <select id="findByIdRange" resultType="com.otr.lotto.domain.Participant">
    SELECT
      id,
      event_id,
      phone_hash,
      check_count,
      first_checked_at,
      last_checked_at,
      created_at,
      updated_at
    FROM participant
    WHERE event_id = #{eventId}
      AND id BETWEEN #{minId} AND #{maxId}
    ORDER BY id
  </select>

  <select id="findAllByEvent" resultType="com.otr.lotto.domain.Participant">
    SELECT
      id,
      event_id,
      phone_hash,
      check_count,
      first_checked_at,
      last_checked_at,
      created_at,
      updated_at
    FROM participant
    WHERE event_id = #{eventId}
    ORDER BY id
  </select>

  <select id="findById" resultType="com.otr.lotto.domain.Participant">
    SELECT
      id,
      event_id,
      phone_hash,
      check_count,
      first_checked_at,
      last_checked_at,
      created_at,
      updated_at
    FROM participant
    WHERE id = #{id}
  </select>

</mapper>
